---
layout: post 
category: papers 
---

Wang C, Wei Q, Wu L, et al. Persisting RB-Tree into NVM in a consistency perspective[J]. ACM Transactions on Storage (TOS), 2018, 14(1): 1-27.

介绍了在NVM上构建持久化的红黑树的算法。在非持久化红黑树的基础上，为每个节点的颜色、左孩子指针、右孩子指针设置两个版本，一个valid版本、另一个是shadow版本。相当于用一棵树的节点数量和两倍的指针数量用一棵树的节点构造了逻辑上的两棵树。每个节点拥有两个版本的颜色和孩子节点指针，为了表述方便，用0号版本和1号版本进行区分。每个节点用一个比特位作为内部版本标识，另外从他的父节点还有一个比特位作为外部版本标识。实际确定版本时，将一个节点的内部版本标识和外部版本标识异或，得到0或者1标识当前节点的valid版本是0号版本或1号版本。红黑树的根节点没有父节点，所以另外设置一个控制节点用两个版本的指针分别指向两棵逻辑树的根节点以及两个根节点的外部版本标识。

这样做的好处是可以直接在shadow版本上对原树进行修改，然后只需要修改控制节点的几个比特的版本标识，就可以将valid版本和shadow版本的两棵树的身份进行调换。（无需为每个节点单独修改版本标识，因为实际版本标识是随着版本计算的异或操作从根节点向整个子树传递的）

